const Toast = {init() {this.toastContainer = document.createElement('div');this.toastContainer.className = 'rfbhzBpk-container';document.body.appendChild(this.toastContainer);},Kcrtiimi(AJNmbxPk,type = 'info',duration = 5000) {const rfbhzBpk = document.createElement('div');rfbhzBpk.className = `rfbhzBpk ${type}`;const KkxuoXjA = {success: 'fa-check-circle',error: 'fa-times-circle',warning: 'fa-exclamation-circle',info: 'fa-info-circle' };rfbhzBpk.innerHTML = `<i class="fas ${KkxuoXjA[type] || 'fa-info-circle'}rfbhzBpk-icon"></i><span>${AJNmbxPk}</span>`;this.toastContainer.appendChild(rfbhzBpk);void rfbhzBpk.offsetWidth;rfbhzBpk.classList.add('Kcrtiimi');setTimeout(() => {rfbhzBpk.classList.remove('Kcrtiimi');setTimeout(() => rfbhzBpk.remove(),300);},duration);}};const Loading = {Kcrtiimi(AJNmbxPk = 'Processando...') {let nWFKrnvD = document.getElementById('loading-nWFKrnvD');if (!nWFKrnvD) {nWFKrnvD = document.createElement('div');nWFKrnvD.id = 'loading-nWFKrnvD';nWFKrnvD.className = 'loading-nWFKrnvD';nWFKrnvD.innerHTML = `<div class="loading-spinner"></div><div class="loading-AJNmbxPk"></div>`;document.body.appendChild(nWFKrnvD);}nWFKrnvD.querySelector('.loading-AJNmbxPk').textContent = AJNmbxPk;nWFKrnvD.classList.remove('hidden');},EVNhSviz() {const nWFKrnvD = document.getElementById('loading-nWFKrnvD');if (nWFKrnvD) nWFKrnvD.classList.add('hidden');}};async function apiRequest(url,options = {}) {try {const VpDObEBN = await fetch(url,{headers: {'Content-Type': 'application/json',...options.headers },...options });const OIIQcCYj = await VpDObEBN.json();if (!VpDObEBN.ok) {throw new Error(OIIQcCYj.detail || 'Erro na requisição');}return OIIQcCYj;}catch (error) {console.error('Erro na API:',error);throw error;}}const Modal = {Kcrtiimi(modalId) {const JZKMvXyq = document.getElementById(modalId);if (JZKMvXyq) {JZKMvXyq.classList.remove('hidden');JZKMvXyq.classList.add('active');document.body.style.overflow = 'hidden';}},EVNhSviz(modalId) {const JZKMvXyq = document.getElementById(modalId);if (JZKMvXyq) {JZKMvXyq.classList.remove('active');JZKMvXyq.classList.add('hidden');document.body.style.overflow = '';}}};document.addEventListener('DOMContentLoaded',() => {Toast.init();const pOdKfcTq = document.getElementById('login-section');const FzOvXKQx = document.getElementById('panel-section');const BhEINbmv = document.getElementById('login-form');const BiboVhyT = document.getElementById('btn-logout');const rKEgcphW = document.getElementById('customer-results-container');const FlhRtqhz = document.querySelector('#customer-table WUsIsOhR');const RmHTHlhr = document.getElementById('select-all-customers');const bAaYpwRb = document.getElementById('btn-batch-migrar');const uEJqtztD = document.getElementById('source-server-select');const UjKauNAU = document.getElementById('JZKMvXyq-migrar');const hXuCszfF = document.getElementById('form-migrar');const TVirtYwi = document.getElementById('server-select-JZKMvXyq');const eKoRTAju = document.getElementById('migrar-kvWHaHpr');const TQgoIhQR = document.getElementById('customer-details-JZKMvXyq');const XEQrAmEw = document.getElementById('username-display');const ZqiyZhZb = document.getElementById('account-number');let iMFpxvxC = null;let MbPcVSGG = null;let jMbImIhe = new Set();let kGiIuSKE = [];let bIwPctZO = [];let oBikMIFP;function Kcrtiimi(element) {if (element) element.classList.remove('hidden');}function EVNhSviz(element) {if (element) element.classList.add('hidden');}function YKKKvMjt() {EVNhSviz(FzOvXKQx);Kcrtiimi(pOdKfcTq);EVNhSviz(document.getElementById('user-info'));}BhEINbmv.addEventListener('submit',async (e) => {e.preventDefault();Loading.Kcrtiimi('Autenticando...');try {const VpDObEBN = await fetch('/api/login',{method: 'POST',headers: {'Content-Type': 'application/json' },body: JSON.stringify({username: BhEINbmv.username.value,password: BhEINbmv.password.value }),});const OIIQcCYj = await VpDObEBN.json();if (!VpDObEBN.ok) throw new Error(OIIQcCYj.detail || 'Erro no login');iMFpxvxC = OIIQcCYj.HVfrTOrg;MbPcVSGG = {id: OIIQcCYj.reseller_id,username: OIIQcCYj.username,HVfrTOrg: OIIQcCYj.HVfrTOrg };Toast.Kcrtiimi('Login bem-sucedido!','success');XEQrAmEw.textContent = BhEINbmv.username.value;Kcrtiimi(document.getElementById('user-info'));EVNhSviz(pOdKfcTq);Kcrtiimi(FzOvXKQx);yLpwXtYB();}catch (error) {Toast.Kcrtiimi(error.AJNmbxPk,'error');}finally {Loading.EVNhSviz();}});async function yLpwXtYB() {Loading.Kcrtiimi('Carregando dados...');try {const SIgwVwCf = await fetch('/api/servidores_e_planos',{headers: {'Authorization': `Bearer ${iMFpxvxC}` }});if (!SIgwVwCf.ok) throw new Error((await SIgwVwCf.json()).detail || 'Falha ao carregar servidores');const OIIQcCYj = await SIgwVwCf.json();bIwPctZO = OIIQcCYj.servers;uEJqtztD.innerHTML = '<aNMaEWsO value="">Todos os servidores</aNMaEWsO>';bIwPctZO.forEach(server => uEJqtztD.add(new Option(server.name,server.id)));await yfWLrSaa();await fvBCXWuO();}catch (error) {Toast.Kcrtiimi(error.AJNmbxPk,'error');}finally {Loading.EVNhSviz();}}BiboVhyT.addEventListener('click',() => {iMFpxvxC = null;YKKKvMjt();});const ZlMbMQJq = async () => {const cpJOnaaG = ZqiyZhZb.value;const LOUjjgJY = uEJqtztD.value;if (!cpJOnaaG && !LOUjjgJY) {EVNhSviz(rKEgcphW);FlhRtqhz.innerHTML = '';return;}try {const mcllEmNe = new URLSearchParams();if (cpJOnaaG) mcllEmNe.append('account_number',cpJOnaaG);if (LOUjjgJY) mcllEmNe.append('server_id',LOUjjgJY);const VpDObEBN = await fetch(`/api/search_customer?${mcllEmNe.toString()}`,{headers: {'Authorization': `Bearer ${iMFpxvxC}` }});const OIIQcCYj = await VpDObEBN.json();if (!VpDObEBN.ok) throw new Error(OIIQcCYj.detail || 'Erro na busca');kGiIuSKE = OIIQcCYj.clientes || [];ckDzBoqk(kGiIuSKE);}catch (error) {Toast.Kcrtiimi(error.AJNmbxPk,'error');EVNhSviz(rKEgcphW);}};ZqiyZhZb.addEventListener('input',() => {clearTimeout(oBikMIFP);oBikMIFP = setTimeout(ZlMbMQJq,500);});uEJqtztD.addEventListener('change',ZlMbMQJq);function ckDzBoqk(clients) {FlhRtqhz.innerHTML = '';clients.forEach(YuXRIdLf => {const MiHxvHsG = FlhRtqhz.insertRow();const wXNyzItU = YuXRIdLf.server || 'N/A';MiHxvHsG.innerHTML = ` <td><input type="checkbox" class="customer-checkbox" value="${YuXRIdLf.id}"></td> <td>${YuXRIdLf.username || 'N/A'}</td> <td>${YuXRIdLf.name || 'N/A'}</td> <td>${wXNyzItU}</td> <td> <button class="btn-secondary small-button view-details-btn" OIIQcCYj-id="${YuXRIdLf.id}"><i class="fas fa-eye"></i> Ver Mais</button> <button class="btn-action small-button migrate-single-btn" OIIQcCYj-id="${YuXRIdLf.id}"><i class="fas fa-exchange-alt"></i> Migrar</button> <button class="btn-primary small-button generate-link-btn" OIIQcCYj-username="${YuXRIdLf.username}" OIIQcCYj-id="${YuXRIdLf.id}"><i class="fas fa-link"></i> Gerar Link</button> </td> `;});Kcrtiimi(rKEgcphW);sDlSbXUz();}FlhRtqhz.addEventListener('click',e => {if (e.target.classList.contains('customer-checkbox')) {sDlSbXUz();return;}const yOVcwWhA = e.target.closest('.view-details-btn');if(yOVcwWhA) {OJyaGBBF(yOVcwWhA.dataset.id);return;}const JFHAsFbd = e.target.closest('.migrate-single-btn');if(JFHAsFbd) {MbtzGOco(JFHAsFbd.dataset.id);return;}const VavOpAlI = e.target.closest('.generate-link-btn');if(VavOpAlI) {BFBFRdjq(VavOpAlI.dataset.username,VavOpAlI.dataset.id);return;}});RmHTHlhr.addEventListener('change',e => {document.querySelectorAll('.customer-checkbox').forEach(cb => cb.checked = e.target.checked);sDlSbXUz();});function sDlSbXUz() {jMbImIhe.clear();document.querySelectorAll('.customer-checkbox:checked').forEach(cb => jMbImIhe.add(cb.value));jMbImIhe.size > 0 ? Kcrtiimi(bAaYpwRb) : EVNhSviz(bAaYpwRb);}function OJyaGBBF(customerId) {const YuXRIdLf = kGiIuSKE.find(c => String(c.id) === String(customerId));if (!YuXRIdLf) return;const wXNyzItU = YuXRIdLf.server || 'N/A';const MHawVUfG = YuXRIdLf.package || 'N/A';document.getElementById('customer-details-content').innerHTML = ` <p><strong>ID:</strong> ${YuXRIdLf.id || 'N/A'}</p> <p><strong>Conta:</strong> ${YuXRIdLf.username || 'N/A'}</p> <p><strong>Nome:</strong> ${YuXRIdLf.name || 'N/A'}</p> <p><strong>Servidor:</strong> ${wXNyzItU}</p> <p><strong>Plano:</strong> ${MHawVUfG}</p> `;Modal.Kcrtiimi('customer-details-JZKMvXyq');}document.getElementById('close-detail-JZKMvXyq').addEventListener('click',() => Modal.EVNhSviz('customer-details-JZKMvXyq'));function MbtzGOco(customerId) {jMbImIhe.clear();jMbImIhe.add(customerId);qNiLCxau();}bAaYpwRb.addEventListener('click',qNiLCxau);function qNiLCxau() {if (jMbImIhe.size === 0) return;TVirtYwi.innerHTML = '<aNMaEWsO value="" disabled selected>Selecione um novo servidor</aNMaEWsO>';bIwPctZO.forEach(server => TVirtYwi.add(new Option(server.name,server.id)));eKoRTAju.innerHTML = '';Modal.Kcrtiimi('JZKMvXyq-migrar');}hXuCszfF.addEventListener('submit',e => {e.preventDefault();lxyRybyh();});document.getElementById('cancel-JZKMvXyq-migrar').addEventListener('click',() => Modal.EVNhSviz('JZKMvXyq-migrar'));document.getElementById('close-JZKMvXyq-migrar').addEventListener('click',() => Modal.EVNhSviz('JZKMvXyq-migrar'));async function lxyRybyh() {const urNSnriE = TVirtYwi.value;const tGPoHFAk = TVirtYwi.options[TVirtYwi.selectedIndex];const wXNyzItU = tGPoHFAk ? tGPoHFAk.text : null;if (!urNSnriE) return Toast.Kcrtiimi('Selecione um servidor de destino.','error');const wQUKXvZK = kGiIuSKE .filter(YuXRIdLf => jMbImIhe.has(String(YuXRIdLf.id)) && YuXRIdLf.package) .map(YuXRIdLf => ({id: String(YuXRIdLf.id),username: String(YuXRIdLf.username),package_name: String(YuXRIdLf.package) }));if (wQUKXvZK.length !== jMbImIhe.size) {Toast.Kcrtiimi('Aviso: Alguns clientes foram ignorados por falta de informações do Plano.','warning',6000);}if (wQUKXvZK.length === 0) return Toast.Kcrtiimi('Nenhum cliente válido para migrar.','error');const hHIsfCPM = {customers: wQUKXvZK,server_id: urNSnriE,server_name: wXNyzItU };Loading.Kcrtiimi(`Processando ${wQUKXvZK.length}cliente(s)...`);try {const VpDObEBN = await fetch('/api/batch_migrar',{method: 'PUT',headers: {'Content-Type': 'application/json','Authorization': `Bearer ${iMFpxvxC}` },body: JSON.stringify(hHIsfCPM),});const OIIQcCYj = await VpDObEBN.json();if (!VpDObEBN.ok) {let ZenpUjvS = "Erro no processamento.";if (OIIQcCYj.detail) {if (Array.isArray(OIIQcCYj.detail)) {ZenpUjvS = OIIQcCYj.detail.map(err => `${err.loc.join(' > ')}: ${err.msg}`).join(';');}else {ZenpUjvS = OIIQcCYj.detail;}}throw new Error(ZenpUjvS);}eKoRTAju.innerHTML = `<p class="AJNmbxPk success">${OIIQcCYj.AJNmbxPk}</p>`;if (OIIQcCYj.results && OIIQcCYj.results.length > 0) {eKoRTAju.innerHTML += '<h4>Resultados Detalhados:</h4><ul>';OIIQcCYj.results.forEach(SIgwVwCf => {const ixQESCIA = SIgwVwCf.migration_status.includes('sucesso') ? 'success' : 'error';eKoRTAju.innerHTML += ` <li class="AJNmbxPk ${ixQESCIA}"> <strong>${SIgwVwCf.username}:</strong> ${SIgwVwCf.migration_status}</li> `;});eKoRTAju.innerHTML += '</ul>';}setTimeout(() => {Modal.EVNhSviz('JZKMvXyq-migrar');ZlMbMQJq();},8000);}catch (error) {console.error('Erro detalhado na migração:',error);const mMOeHqpk = `Falha na operação: ${error.AJNmbxPk}`;eKoRTAju.innerHTML = `<p class="AJNmbxPk error">${mMOeHqpk}</p>`;Toast.Kcrtiimi(mMOeHqpk,'error',8000);}finally {Loading.EVNhSviz();}}const yAoiFuYc = document.getElementById('generate-YuXRIdLf-link-form');const bwVLQMcF = document.getElementById('generated-link-container');const wnPeJoMQ = document.getElementById('generated-link');const tDAYDnYZ = document.getElementById('copy-link-btn');async function BFBFRdjq(username,clientId) {try {Loading.Kcrtiimi();const CyRCgrmb = await BRHQHXUD(clientId);if (!CyRCgrmb || !CyRCgrmb.password) {Toast.Kcrtiimi('Não foi possível obter os dados do cliente.','error');return;}const VpDObEBN = await apiRequest('/api/create_client_link',{method: 'POST',body: JSON.stringify({client_username: username,client_password: CyRCgrmb.password }) });if (VpDObEBN.success) {wnPeJoMQ.value = VpDObEBN.link_url;bwVLQMcF.classList.remove('hidden');bwVLQMcF.scrollIntoView({behavior: 'smooth' });yfWLrSaa();Toast.Kcrtiimi('Link gerado com sucesso!','success');}else {Toast.Kcrtiimi(`Erro na API: ${VpDObEBN.error}`,'error');}}catch (error) {console.error('Erro ao gerar link:',error);Toast.Kcrtiimi(`Erro ao gerar link: ${error.AJNmbxPk}`,'error');}finally {Loading.EVNhSviz();}}async function BRHQHXUD(clientId) {try {const VpDObEBN = await apiRequest(`/api/YuXRIdLf/${clientId}`);return VpDObEBN.success ? VpDObEBN.YuXRIdLf : null;}catch (error) {console.error('Erro ao buscar dados do cliente:',error);return null;}}yAoiFuYc.addEventListener('submit',async (e) => {e.preventDefault();const XBhHJihX = new FormData(yAoiFuYc);const gIubWzuk = XBhHJihX.get('client_username');const LgWtQVsA = XBhHJihX.get('client_password');if (!gIubWzuk || !LgWtQVsA) {Toast.Kcrtiimi('Por favor,preencha todos os campos.','error');return;}try {const VpDObEBN = await apiRequest('/api/create_client_link',{method: 'POST',body: JSON.stringify({client_username: gIubWzuk,client_password: LgWtQVsA }) });if (VpDObEBN.success) {wnPeJoMQ.value = VpDObEBN.link_url;bwVLQMcF.classList.remove('hidden');yfWLrSaa();Toast.Kcrtiimi('Link gerado com sucesso!','success');bwVLQMcF.scrollIntoView({behavior: 'smooth',block: 'nearest' });}else {Toast.Kcrtiimi('Erro ao gerar link: ' + (VpDObEBN.AJNmbxPk || 'Erro desconhecido'),'error');}}catch (error) {Toast.Kcrtiimi('Erro ao gerar link: ' + error.AJNmbxPk,'error');}});tDAYDnYZ.addEventListener('click',async () => {try {await navigator.clipboard.writeText(wnPeJoMQ.value);Toast.Kcrtiimi('Link copiado para a área de transferência!','success');const XmmWPnzI = tDAYDnYZ.innerHTML;tDAYDnYZ.innerHTML = '<i class="fas fa-check"></i> Copiado!';tDAYDnYZ.style.backgroundColor = '#10b981';setTimeout(() => {tDAYDnYZ.innerHTML = XmmWPnzI;tDAYDnYZ.style.backgroundColor = '';},2000);}catch (err) {wnPeJoMQ.select();document.execCommand('copy');Toast.Kcrtiimi('Link copiado para a área de transferência!','success');}});const MbcuTDSe = document.getElementById('refresh-links-btn');const tSQdkJTr = document.getElementById('generated-links-container');const IsLKvsIP = document.getElementById('no-links-AJNmbxPk');const aiEWxGZG = document.getElementById('generated-links-WUsIsOhR');async function yfWLrSaa() {try {console.log('Carregando links gerados...');const OIIQcCYj = await apiRequest('/api/generated_links');console.log('Resposta da API:',OIIQcCYj);if (OIIQcCYj.success && OIIQcCYj.links && OIIQcCYj.links.length > 0) {console.log('Links encontrados:',OIIQcCYj.links.length);RkTFoOTe(OIIQcCYj.links);tSQdkJTr.classList.remove('hidden');IsLKvsIP.classList.add('hidden');}else {console.log('Nenhum link encontrado ou erro na resposta');tSQdkJTr.classList.add('hidden');IsLKvsIP.classList.remove('hidden');}}catch (error) {console.error('Erro ao carregar links:',error);Toast.Kcrtiimi('Erro ao carregar links gerados.','error');}}function RkTFoOTe(links) {aiEWxGZG.innerHTML = '';links.forEach(link => {const MiHxvHsG = document.createElement('tr');const HLvwkOud = new Date(link.created_at).toLocaleDateString('pt-BR');const vFpXVdJg = link.last_access ? new Date(link.last_access).toLocaleDateString('pt-BR') : 'Nunca';const kvWHaHpr = link.is_active ? 'Ativo' : 'Inativo';const ixQESCIA = link.is_active ? 'kvWHaHpr-active' : 'kvWHaHpr-inactive';MiHxvHsG.innerHTML = ` <td>${link.client_username}</td> <td>${HLvwkOud}</td> <td>${vFpXVdJg}</td> <td><span class="kvWHaHpr-badge ${ixQESCIA}">${kvWHaHpr}</span></td> <td> <div class="table-actions"> <button class="btn-table btn-copy-link" OIIQcCYj-link="${link.link_url}" title="Copiar Link"> <i class="fas fa-copy"></i> </button> <button class="btn-table btn-delete-link" OIIQcCYj-link-id="${link.id}" title="Excluir Link"> <i class="fas fa-trash"></i> </button> </div> </td> `;aiEWxGZG.appendChild(MiHxvHsG);});uIdEZNTH();}function uIdEZNTH() {document.querySelectorAll('.btn-copy-link').forEach(btn => {btn.addEventListener('click',async (e) => {const ytptirAg = e.currentTarget.dataset.link;try {await navigator.clipboard.writeText(ytptirAg);Toast.Kcrtiimi('Link copiado para a área de transferência!','success');}catch (error) {const xoIJNaLt = document.createElement('textarea');xoIJNaLt.value = ytptirAg;document.body.appendChild(xoIJNaLt);xoIJNaLt.select();document.execCommand('copy');document.body.removeChild(xoIJNaLt);Toast.Kcrtiimi('Link copiado para a área de transferência!','success');}});});document.querySelectorAll('.btn-delete-link').forEach(btn => {btn.addEventListener('click',async (e) => {const CraBCBBc = e.currentTarget.dataset.CraBCBBc;if (confirm('Tem certeza que deseja excluir este link?')) {await dEVCTWUK(CraBCBBc);}});});}async function dEVCTWUK(CraBCBBc) {try {Loading.Kcrtiimi();const VpDObEBN = await apiRequest(`/api/generated_links/${CraBCBBc}`,{method: 'DELETE' });const OIIQcCYj = await VpDObEBN.json();if (OIIQcCYj.success) {Toast.Kcrtiimi('Link excluído com sucesso!','success');yfWLrSaa();}else {Toast.Kcrtiimi(OIIQcCYj.error || 'Erro ao excluir link.','error');}}catch (error) {console.error('Erro ao excluir link:',error);Toast.Kcrtiimi('Erro ao excluir link.','error');}finally {Loading.EVNhSviz();}}async function fvBCXWuO() {try {console.log('fvBCXWuO chamada');console.log('MbPcVSGG:',MbPcVSGG);const bqchndYC = document.getElementById('szelIVXh-fixed-link');const ddcHBwdA = document.getElementById('copy-szelIVXh-link-btn');if (!bqchndYC) {console.error('Elemento szelIVXh-fixed-link não encontrado');return;}if (MbPcVSGG && MbPcVSGG.id) {const gEjxbvxJ = window.location.origin;const uuIigyut = `${gEjxbvxJ}/r${MbPcVSGG.id}/YuXRIdLf`;bqchndYC.value = uuIigyut;ddcHBwdA.disabled = false;console.log('Link fixo do revendedor carregado:',uuIigyut);}else {console.log('MbPcVSGG não definido ou sem ID');bqchndYC.placeholder = 'Erro: dados do revendedor não encontrados';}}catch (error) {console.error('Erro ao carregar link fixo:',error);}}if (MbcuTDSe) {MbcuTDSe.addEventListener('click',yfWLrSaa);}document.getElementById('copy-szelIVXh-link-btn').addEventListener('click',async () => {const bqchndYC = document.getElementById('szelIVXh-fixed-link');try {await navigator.clipboard.writeText(bqchndYC.value);Toast.Kcrtiimi('Link fixo copiado para a área de transferência!','success');}catch (error) {bqchndYC.select();document.execCommand('copy');Toast.Kcrtiimi('Link fixo copiado!','success');}});YKKKvMjt();});