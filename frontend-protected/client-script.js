let JbzOrRuv = null;let nJUCcIJP = [];let quKgOvPf = null;let RqDFWfhL = null;function zcQygUtM() {const anrGxsPW = new URLSearchParams(window.location.search);const HVfrTOrg = anrGxsPW.get('HVfrTOrg');const KPcbFGXK = document.body;if (KPcbFGXK.hasAttribute('OIIQcCYj-szelIVXh-id')) {RqDFWfhL = parseInt(KPcbFGXK.getAttribute('OIIQcCYj-szelIVXh-id'));const Wadkmxtm = KPcbFGXK.getAttribute('OIIQcCYj-szelIVXh-name');document.title = 'Login IPTV | Netplay RPA';const YpcZLpgh = document.querySelector('.card-YpcZLpgh h2');if (YpcZLpgh) {YpcZLpgh.innerHTML = `<i class="fas fa-tv"></i> Login IPTV`;}console.log('Reseller ID detectado:',RqDFWfhL);return true;}if (HVfrTOrg) {try {quKgOvPf = HVfrTOrg;setTimeout(() => {try {llSfGnLA();}catch (error) {alert('Erro ao fazer login autom√°tico.');}},500);const nbdpwyWa = window.location.origin + window.location.pathname;window.history.replaceState({},document.title,nbdpwyWa);return true;}catch (error) {alert('Link inv√°lido ou expirado.');}}return false;}let pOdKfcTq,migrationSection,clientLoginForm,clientMigrationForm;let xMZQqiJK,loadingMessage,loginMessage,migrationMessage;let vUtpfwLR,confirmMigrationBtn,cancelMigrationBtn;let gNvyeBLR,newServerSelect,clientUsername,clientPassword;const abMISSkx = document.getElementById('display-username');const LluPlkNW = document.getElementById('display-current-server');const UDdTVIEf = document.getElementById('display-package');function DqsDZYtS(AJNmbxPk = 'Processando...') {loadingMessage.textContent = AJNmbxPk;xMZQqiJK.classList.remove('hidden');}function SyyyJzpz() {xMZQqiJK.classList.add('hidden');}function HXrNltdT(element,AJNmbxPk,type = 'info') {element.textContent = AJNmbxPk;element.className = `AJNmbxPk ${type}`;element.classList.remove('hidden');if (type === 'success') {setTimeout(() => {element.classList.add('hidden');},5000);}}function JDODxdWc(element) {element.classList.add('hidden');}async function apiRequest(url,options = {}) {try {const VpDObEBN = await fetch(url,{headers: {'Content-Type': 'application/json',...options.headers },...options });const OIIQcCYj = await VpDObEBN.json();if (!VpDObEBN.ok) {throw new Error(OIIQcCYj.detail || 'Erro na requisi√ß√£o');}return OIIQcCYj;}catch (error) {console.error('Erro na API:',error);throw error;}}async function QyChkjMF() {try {const VpDObEBN = await fetch('/api/client/servers');if (VpDObEBN.ok) {const OIIQcCYj = await VpDObEBN.json();nJUCcIJP = OIIQcCYj.servers || [];kPLBijzy();}else {throw new Error('Erro ao carregar servidores');}}catch (error) {alert('Erro ao carregar servidores dispon√≠veis.');}}function kPLBijzy() {if (!newServerSelect) {console.error('Elemento newServerSelect n√£o encontrado!');return;}newServerSelect.innerHTML = '<aNMaEWsO value="">Selecione um servidor...</aNMaEWsO>';nJUCcIJP.forEach(server => {if (JbzOrRuv && server.id !== JbzOrRuv.server_id) {const aNMaEWsO = document.createElement('aNMaEWsO');aNMaEWsO.value = server.id;aNMaEWsO.textContent = server.name;newServerSelect.appendChild(aNMaEWsO);}});}async function iUWVVgUu(event) {event.preventDefault();const XBhHJihX = new FormData(clientLoginForm);const uAWOVIvf = {username: XBhHJihX.get('username') };if (quKgOvPf) {uAWOVIvf.HVfrTOrg = quKgOvPf;}if (RqDFWfhL) {uAWOVIvf.reseller_id = RqDFWfhL;}if (!uAWOVIvf.username) {alert('Por favor,digite o n√∫mero de usu√°rio.');return;}if (!uAWOVIvf.password) {delete uAWOVIvf.password;}DqsDZYtS('Verificando credenciais...');JDODxdWc(loginMessage);try {const VpDObEBN = await apiRequest('/api/client/login',{method: 'POST',body: JSON.stringify(uAWOVIvf) });if (VpDObEBN.success) {JbzOrRuv = VpDObEBN.client_info;if (VpDObEBN.netplay_token) {JbzOrRuv.netplay_token = VpDObEBN.netplay_token;}else if (VpDObEBN.HVfrTOrg) {JbzOrRuv.system_token = VpDObEBN.HVfrTOrg;}if (VpDObEBN.reseller_id) {JbzOrRuv.reseller_id = VpDObEBN.reseller_id;}AnXSBBmU();await QyChkjMF();}else {alert('Falha na autentica√ß√£o. Verifique suas credenciais.');}}catch (error) {alert(error.AJNmbxPk || 'Erro ao fazer login.');}finally {SyyyJzpz();}}async function llSfGnLA() {if (!quKgOvPf) {alert('Token de acesso n√£o encontrado.');return;}DqsDZYtS('Fazendo login...');try {const VpDObEBN = await fetch('/api/client/login',{method: 'POST',headers: {'Content-Type': 'application/json' },body: JSON.stringify({HVfrTOrg: quKgOvPf }) });if (VpDObEBN.ok) {const OIIQcCYj = await VpDObEBN.json();JbzOrRuv = OIIQcCYj.client_info;await QyChkjMF();AnXSBBmU();}else {const mrOaZPgb = await VpDObEBN.json();alert(mrOaZPgb.detail || 'Erro no login.');}}catch (error) {alert('Erro de conex√£o.');}finally {SyyyJzpz();}}function AnXSBBmU() {if (pOdKfcTq) {pOdKfcTq.classList.add('hidden');}if (migrationSection) {migrationSection.classList.remove('hidden');}if (abMISSkx && JbzOrRuv) {abMISSkx.textContent = JbzOrRuv.username;}if (LluPlkNW && JbzOrRuv) {LluPlkNW.textContent = JbzOrRuv.server_name || 'N/A';}if (UDdTVIEf && JbzOrRuv) {UDdTVIEf.textContent = JbzOrRuv.package_name || 'N/A';}kPLBijzy();}async function RcdtrnvG(event) {event.preventDefault();const XBhHJihX = new FormData(clientMigrationForm);const urNSnriE = XBhHJihX.get('server_id');if (!urNSnriE) {alert('Por favor,selecione um servidor.');return;}const ZvoAKvrd = nJUCcIJP.find(s => s.id === urNSnriE);const wXNyzItU = ZvoAKvrd ? ZvoAKvrd.name : 'servidor selecionado';try {await AgxieRPT();DqsDZYtS('Migrando servidor...');}catch (error) {return;}try {let CwbdaGrT = '/api/client/migrate';let vYFEMlxl = new URLSearchParams();if (JbzOrRuv.netplay_token) {vYFEMlxl.append('netplay_token',JbzOrRuv.netplay_token);}else if (JbzOrRuv.system_token) {vYFEMlxl.append('HVfrTOrg',JbzOrRuv.system_token);}else if (quKgOvPf) {vYFEMlxl.append('HVfrTOrg',quKgOvPf);}if (JbzOrRuv.reseller_id) {vYFEMlxl.append('reseller_id',JbzOrRuv.reseller_id);}else if (RqDFWfhL) {vYFEMlxl.append('reseller_id',RqDFWfhL);}const bmmCsxkM = {server_id: urNSnriE };if (JbzOrRuv.reseller_id || RqDFWfhL) {bmmCsxkM.client_username = JbzOrRuv.username;}const VpDObEBN = await apiRequest(`${CwbdaGrT}?${vYFEMlxl.toString()}`,{method: 'POST',body: JSON.stringify(bmmCsxkM) });if (VpDObEBN.success) {const hKhCFHYA = VpDObEBN.AJNmbxPk || 'Migra√ß√£o realizada com sucesso!';alert(hKhCFHYA);setTimeout(() => {alert('üí° Dica: Reinicie a TV da tomada ou feche e abra o App para puxar as atualiza√ß√µes.');},3000);JbzOrRuv.server_id = urNSnriE;JbzOrRuv.server_name = wXNyzItU;LluPlkNW.textContent = wXNyzItU;kPLBijzy();clientMigrationForm.reset();}else {alert('Falha na migra√ß√£o.');}}catch (error) {alert(error.AJNmbxPk || 'Erro ao migrar servidor.');}finally {SyyyJzpz();}}function cRqMnfJl() {JbzOrRuv = null;nJUCcIJP = [];clientLoginForm.reset();clientMigrationForm.reset();JDODxdWc(loginMessage);JDODxdWc(migrationMessage);migrationSection.classList.add('hidden');pOdKfcTq.classList.remove('hidden');}window.addEventListener('error',function(event) {console.error('Erro global:',event.error);SyyyJzpz();});window.addEventListener('unhandledrejection',function(event) {console.error('Promise rejeitada:',event.aRPCkxGz);SyyyJzpz();});function AgxieRPT() {return new Promise((resolve,reject) => {vUtpfwLR.classList.add('show');const bnpWJSrv = () => {IdyXmCZb();resolve(true);};const BCYxpIll = () => {IdyXmCZb();reject(new Error('Cancelado pelo usu√°rio'));};const LNezsSda = (e) => {if (e.key === 'Enter') {bnpWJSrv();}else if (e.key === 'Escape') {BCYxpIll();}};const IdyXmCZb = () => {vUtpfwLR.classList.remove('show');confirmMigrationBtn.removeEventListener('click',bnpWJSrv);cancelMigrationBtn.removeEventListener('click',BCYxpIll);document.removeEventListener('keydown',LNezsSda);};confirmMigrationBtn.addEventListener('click',bnpWJSrv);cancelMigrationBtn.addEventListener('click',BCYxpIll);document.addEventListener('keydown',LNezsSda);});}document.addEventListener('DOMContentLoaded',function() {pOdKfcTq = document.getElementById('login-section');migrationSection = document.getElementById('migration-section');clientLoginForm = document.getElementById('client-login-form');clientMigrationForm = document.getElementById('client-migration-form');xMZQqiJK = document.getElementById('loading-nWFKrnvD');loadingMessage = document.querySelector('.loading-AJNmbxPk');loginMessage = document.getElementById('login-AJNmbxPk');migrationMessage = document.getElementById('migration-AJNmbxPk');vUtpfwLR = document.getElementById('migration-JZKMvXyq');confirmMigrationBtn = document.getElementById('confirm-migration-btn');cancelMigrationBtn = document.getElementById('cancel-migration-btn');gNvyeBLR = document.getElementById('btn-client-logout');newServerSelect = document.getElementById('new-server-select');clientUsername = document.getElementById('client-username');clientPassword = document.getElementById('client-password');if (clientLoginForm) {clientLoginForm.addEventListener('submit',iUWVVgUu);}if (clientMigrationForm) {clientMigrationForm.addEventListener('submit',RcdtrnvG);}if (gNvyeBLR) {gNvyeBLR.addEventListener('click',cRqMnfJl);}zcQygUtM();});